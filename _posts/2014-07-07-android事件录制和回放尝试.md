---
layout: post
title: android事件录制和回放尝试
keywords: Android
description: Android
categories: [Android]
tags: [Android]
group: archive
icon: globe
---
# 遇到的问题
前段时间在开发定位SDK，近期基于已完成的定位SDK实现地理围栏功能。无论开发定位SDK还是地理围栏，路测
都是个非常麻烦的问题。功能稳定后进行路测还好，但平常总不能动不动改了代码 就出去测一圈吧？简单总结下，
目前遇到的问题是：真实路测比较耗时，而在室内又难以验证代码在真实环境中的运行状况。

# 模拟测试
上面提到的问题，谷歌在开发 android location 相关功能时，肯定也遇到过。在模拟器上，他们提供模拟测试来
解决这个问题：
![](../assets/20140707/emulator_control_location.png)

而在 android 真机上还可以使用 mock location [TODO]

# 如何模拟基站和WiFi
并没有现成的模拟基站切换和信号强度变化、WiFi扫描结果变化的方案。自己设计的方案如下：

![](../assets/20140707/event_recorder_recordmode.png)

图中的 WifiProvider 和 CellProvider 分别是 SDK 中负责处理 WiFi 变化和基站变化的部分。前者监听
 WifiManager.SCAN_RESULTS_AVAILABLE_ACTION [TODO] 广播，后者监听 PhoneStateListener.LISTEN_CELL_LOCATION [TODO] 变化。EventRecorder 是一个录制工具，处于录制模式时将在 WifiProvider 和 CellProvider 处理
相应事件之前录制各个事件，比如基站切换等等；而处于播放模式时， EventRecorder 将向 WifiProvider 和 CellProvider 
发送模拟事件，以驱动 SDK 工作。

主要的事件包括: 
+ CellIdChangedEvent: 基站切换
+ CellStrengthChangedEvent: 基站信号强度变化
+ GpsChangedEvent: 得到新的GPS位置
+ WifiResultChangedEvent: 得到新的 WiFi 扫描结果

如果模拟事件能反映真实的基站和 WiFi 变化过程，我们基本可以重现之前的录制过程。开发相关功能时，仅使用之前录制
的事件序列就可以来测试了，完全没有必要外出路测，从而大大提高开发效率

# 方案存在的不足

为了进行 CellIdChangedEvent 事件录制，CellProvider 需要改成这样。
	@Override
	public void onCellLocationChanged(CellLocation location) {
		super.onCellLocationChanged(location);
	
		if (录制模式) {
			eventRecorder.record(event);
		}
	
		// SDK 代码逻辑
	}

其他相关代码也要做相应修改，可见 EventRecorder跟业务逻辑的耦合非常强，是侵入式的，完全破坏了原来的代码结构。一旦正式
发布，必须通过某种手段去掉这些代码，形成新的负担。

# 使用接口替换类


# 100%真实吗
