---
layout: post
title: LocationManagerService的初始化
keywords: Android,Location
description: Android
categories: [Android]
tags: [Android]
group: archive
icon: globe
---
LocationManagerService的初始化时序如下

![]({{ site.url }}/assets/20140108/location-init.PNG)

`LocationManagerService` 除提供定位功能外，还提供 `Geofence` 功能。这里我们只关注定位部分。所以不讨论 `GeofenceManager` 相关的东西。

以上时序，第3、4步为 "prepare providers" 阶段，第5步为 "listen for settings changes" 阶段。下面分别有讨论。

`LocationManagerService` 代码路径为：platform_\frameworks\_base\services\java\com\android\server\LocationManagerService.java

# 0. 准备 Providers
可细分为 "load providers" 和 "update providers" 两步， 前者主要是根据系统配置加载各个 Provider，后者是更新这些 Provider 的状态。

# 0.0 加载
从名字可以看出，加载 Providers 的过程对应于 `loadProvidersLocked()` 方法。

1. PassiveProvider， 被动定位。永远启用, 非 RealProvider
2. GpsLocationProvider， GPS定位。硬件支持时可启用， <font color='red'>是 RealProvider</font>
3. NetworkProvider，网络定位。 安装相应的包后可启用，<font color='red'>是 RealProvider</font>
4. FusedProvider， 多方式混合定位。安装相应的包后可启用, <font color='red'>是 RealProvider</font>
5. GeocoderProvider, 地理编码和反编码。安装相应的包后可启用
6. FlpHardwareProvider, (不清楚这个是什么)
7. GeofenceProvider，地理围栏功能。 安装相应的包后可启用。

以上 1-4 属于定位相关的 Provider, 而真正具备定位功能的是 2, 3, 4，所以说它们是 RealProvider。 

这里简单解释下什么是 [PassiveProvider](http://developer.android.com/reference/android/location/LocationManager.html#PASSIVE_PROVIDER)
>This provider can be used to passively receive location updates when other applications or services request them without actually requesting the locations yourself. This provider will return locations generated by other providers. 

以上 3, 4, 5, 7 都需要安装相应的包会才能使用。 但实际上，加载这几个 Provider 时都需要读取类似以下的配置项

	com.android.internal.R.string.config_xxxProviderPackageName
所以不仅相应的包需要安装，还要修改相应的配置项。配置文件的路径是 `platform_frameworks_base\core\res\res\values\config.xml`。比如网络定位对应于 `config_networkLocationProviderPackageName`

	...
    <bool name="config_enableNetworkLocationOverlay" translatable="false">true</bool>
    <!-- Package name providing network location support. Used only when
         config_enableNetworkLocationOverlay is false. -->
    <string name="config_networkLocationProviderPackageName" translatable="false">@null</string> 
	...

加载定位相关的 Provider 过程中，根据 Provider 是否启用、是否Real、是否使用Proxy，会将各 Provider 实例添加到集合当中。汇总如下

<table>
<tr>
<td>x</td>
<td>mProviders</td>
<td>mEnabledProviders</td>
<td>mRealProviders</td>
<td>mProxyProviders</td>
</tr>

<td>PassiveProvider</td>
<td>Y</td>
<td>Y</td>
<td></td>
<td></td>
</tr>

<td>GpsLocationProvider</td>
<td>Y</td>
<td></td>
<td>Y</td>
<td></td>
</tr>

<td>NetworkProvider</td>
<td>Y</td>
<td></td>
<td>Y</td>
<td>Y</td>
</tr>

<td>FusedProvider</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>

</table>

注： 上表中 mProviders 等均为Map，Y 表示添加

完整加载过程比较复杂。我们关注的是 NetworkProvider 部分，后面会专门详细讨论这个过程。

# 0.1 更新
从名字可以看出，更新 Providers 的过程对应于 `updateProvidersLocked()` 方法。

    private void updateProvidersLocked() {
        boolean changesMade = false;
        for (int i = mProviders.size() - 1; i >= 0; i--) {
            LocationProviderInterface p = mProviders.get(i);
            boolean isEnabled = p.isEnabled();
            String name = p.getName();
            boolean shouldBeEnabled = isAllowedByCurrentUserSettingsLocked(name);
            if (isEnabled && !shouldBeEnabled) {
                updateProviderListenersLocked(name, false, mCurrentUserId);
                changesMade = true;
            } else if (!isEnabled && shouldBeEnabled) {
                updateProviderListenersLocked(name, true, mCurrentUserId);
                changesMade = true;
            }
        }
        if (changesMade) {
            mContext.sendBroadcastAsUser(new Intent(LocationManager.PROVIDERS_CHANGED_ACTION),
                    UserHandle.ALL);
            mContext.sendBroadcastAsUser(new Intent(LocationManager.MODE_CHANGED_ACTION),
                    UserHandle.ALL);
        }
    }

上面代码简单总结如下：

1. 遍历 mProviders 中的元素
2. 判断是否需要启用当前 Provider，调用相应的 `updateProviderListenersLocked()` 方法
3. 如果当前 Provider 有关联的 `Receiver`，移除
4. 调用 `enable()` 或 `disable()` 启用或关闭 Provider
5. 如果是启用， 且当前 Provider 仍然有关联的 定位请求， 处理这些请求

我们关注的是 NetworkProvider 部分，后面会专门详细讨论这里的 "启用或关闭 Provider" 以及 "处理定位请求"

# 1. 监听
监听的事件包括：

1. 监听 Provider 是否启用或禁用。 即 `Settings.Secure.LOCATION_PROVIDERS_ALLOWED` 值的变化
2. 监听程序包的卸载或禁用。
3. 监听用户切换。 即 `Intent.ACTION_USER_SWITCHED` 广播

监听的事件发生后，`LocationManagerService` 会进行相应的处理。比如，一旦程序被卸载， 需要 remove all receivers associated with this package；或者，用户在 Settings 模块中关闭了网络定位功能，需要更新 Provider 的状态。 

这里不详细讨论监听。

注意：`LocationManagerService` 监听 Provider 是否启用或禁用，是用户可以通过 Settings 模块中的位置功能来开关网络定位的关键。